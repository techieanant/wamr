# WAMR Docker Compose Configuration
# Single container serving both frontend and backend
# Uses .env.prod for configuration
# Build: npm run docker:build
# Start: npm run docker:up
# Logs:  npm run docker:logs
# Stop:  npm run docker:down

services:
  wamr:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        # Frontend uses root path, API routes already have /api prefix
        - VITE_API_URL=/
    container_name: wamr-combined
    restart: unless-stopped
    env_file:
      - .env.prod
    ports:
      - "${PORT:-9000}:${PORT:-9000}"
    environment:
      # All configuration comes from .env.prod
      # These are just ensuring required variables exist
      - NODE_ENV=${NODE_ENV}
      - PORT=${PORT}
      - DATABASE_PATH=${DATABASE_PATH}
      - JWT_SECRET=${JWT_SECRET:?JWT_SECRET is required}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY:?ENCRYPTION_KEY is required}
      - ADMIN_USERNAME=${ADMIN_USERNAME}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:?ADMIN_PASSWORD is required}
      - RATE_LIMIT_WINDOW_MS=${RATE_LIMIT_WINDOW_MS}
      - RATE_LIMIT_MAX_REQUESTS=${RATE_LIMIT_MAX_REQUESTS}
      - LOGIN_RATE_LIMIT_MAX=${LOGIN_RATE_LIMIT_MAX}
      - WHATSAPP_SESSION_PATH=${WHATSAPP_SESSION_PATH}
      - MEDIA_MONITORING_INTERVAL_MS=${MEDIA_MONITORING_INTERVAL_MS}
      - LOG_LEVEL=${LOG_LEVEL}
      - LOG_PRETTY=${LOG_PRETTY}
    volumes:
      - wamr-data:/app/data
      - wamr-whatsapp-auth:/app/.wwebjs_auth
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('http').get('http://localhost:${PORT}/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})",
        ]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 40s

volumes:
  wamr-data:
    driver: local
  wamr-whatsapp-auth:
    driver: local
