# WAMR Docker Compose Configuration
# Single container serving both frontend and backend
# Uses .env.prod for configuration
# Build: npm run docker:build
# Start: npm run docker:up
# Logs:  npm run docker:logs
# Stop:  npm run docker:down

services:
  wamr:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        # Frontend uses root path, API routes already have /api prefix
        - VITE_API_URL=/
    container_name: wamr-combined
    restart: unless-stopped
    env_file:
      - .env.prod
    ports:
      - "${PORT:-9000}:${PORT:-9000}"
    volumes:
      - wamr-data:/app/data
      - wamr-whatsapp-auth:/app/.baileys_auth
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('http').get('http://localhost:${PORT:-9000}/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})",
        ]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 40s

volumes:
  wamr-data:
    driver: local
  wamr-whatsapp-auth:
    driver: local
